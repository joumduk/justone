{"version":3,"sources":["mergePatch.ion"],"names":["ion","isObject",{"type":"Identifier","name":"isObject","loc":{"start":{"line":3,"column":4,"fixed":true,"source":"ion/mergePatch.ion"},"end":{"line":3,"column":12,"fixed":true,"source":"ion/mergePatch.ion"}}},"a","type","deleteValue","isPrivate","name","canSetProperty","object","key","merge","target","values","options","deleteNull","constructor","Object","factory","value","newValue","combine","patch1","patch2","watch","handler","priority","Error","count","watching","propertyWatchers","watchProperties","changes","properties","map","keys","patch","unobserve","observe","unwatch","diff","oldValue","hasOwnProperty","propertyDiff","isChange","test","equal","b","c","d","double","x","f","e","done","source","age","children","Sadera","grandchildren","One","Two","Orion","Third","clone","three","checkForChanges"],"mappings":"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","sourcesContent":["const\n    ion = import './'\n    isObject = (a) ->\n        let type = typeof a\n        return a? and type is 'object' or type is 'function'\n    deleteValue = null\n    isPrivate = (name) -> name[0] is '_'\n\nexport const\n    canSetProperty = (object, key) -> not (typeof object is 'function' and key is 'name')\n    # options:\n    #   deleteNull: delete properties if value is null, default: true\n    #   factory: function to use when constructing new objects, defaults to using plain objects {}\n    merge = (target, values, options) ->\n        let deleteNull = options?.deleteNull ? true\n        if values?.constructor isnt Object\n            return values\n        if not isObject(target)\n            if options?.factory?\n                target = options.factory(values)\n            else\n                target = {}\n        for key, value of values\n            if deleteNull and value is deleteValue\n                delete target[key]\n            else\n                let newValue = merge(target[key], value, options)\n                if canSetProperty(target, key)\n                    target[key] = newValue\n        return target\n    # combines two patches to make a single patch\n    combine = (patch1, patch2) -> merge(patch1, patch2, {deleteNull:false})\n    # watches object for changes and calls the handler with patches\n    watch = (object, handler, priority) ->\n        if not isObject(object)\n            throw new Error(\"Cannot watch: #{object}\")\n        watch.count = (watch.count ? 0) + 1\n        # watch.objects ?= []\n        # watch.objects.push(object)\n        let watching = true\n        let propertyWatchers = {}\n        let watchProperties = (changes) ->\n            let properties = changes?.map((a) -> a.name) ? Object.keys(object)\n            for name in properties\n                do (name) ->\n                    if watching\n                        propertyWatchers[name]?()\n                        let value = object[name]\n                        if isObject(value)\n                            propertyWatchers[name] = watch(\n                                value\n                                (patch) ->\n                                    handler({[name]:patch})\n                                priority\n                            )\n                        else\n                            delete propertyWatchers[name]\n\n        watchProperties(null)\n        let unobserve = ion.observe(\n            object\n            (changes) ->\n                if watching\n                    let patch = null\n                    for {name} in changes\n                        # we ignore names that start with underscore, they are considered private\n                        if not isPrivate(name)\n                            patch ?= {}\n                            # we convert undefined values from delete into explicit nulls\n                            patch[name] = object[name] ? deleteValue\n                    watchProperties(changes)\n                    if patch?\n                        handler(patch)\n        )\n        return ->\n            watch.count--\n            # watch.objects.remove(object)\n            watching = false\n            unobserve()\n            unobserve = null\n            for key, unwatch of propertyWatchers\n                unwatch()\n            propertyWatchers = null\n\n    # watch = (object, handler, priority = 0, callInitial = true) ->\n    #     if callInitial\n    #         watch.count = (watch.count ? 0) + 1\n    #     if not isObject(object)\n    #         throw new Error(\"Cannot watch: #{object}\")\n    #     # recurse watching and unwatching\n    #     let subWatchers = {}\n    #     # pending patch allows several changes at simultaneous levels of the\n    #     # heirarchy to be combined into a single patch call\n    #     let pendingPatch = null\n    #     let processPatch = (patchValues) ->\n    #         # watch sub objects\n    #         for name of patchValues\n    #             # unwatch any current value being watched\n    #             # now watch sub values if we can\n    #             subWatchers[name]?()\n    #             let value = object[name]\n    #             if isObject(value)\n    #                 do (name) ->\n    #                     let subHandler = (patch) ->\n    #                         queuePatch({[name]:patch})\n    #                     subWatchers[name] = watch(value, subHandler, priority, false)\n    #     let pendingTimeout = null\n    #     let queuePatch = (patch) ->\n    #         # console.log(JSON.stringify(patch))\n    #         if not callInitial\n    #             handler(patch)\n    #         else\n    #             pendingPatch = combine(pendingPatch, patch)\n    #             processPatch(pendingPatch)\n    #             pendingTimeout ?= setTimeout(\n    #                 ->\n    #                     handler(pendingPatch)\n    #                     pendingPatch = null\n    #                     pendingTimeout = null\n    #                 0\n    #             )\n    #     let watcher = (changes) ->\n    #         let patch = null\n    #         for change in changes\n    #             # we ignore names that start with underscore, they are considered private\n    #             if change.name[0] isnt '_'\n    #                 patch ?= {}\n    #                 # we convert undefined values from delete into explicit nulls\n    #                 patch[change.name] = object[change.name] ? deleteValue\n    #         if patch?\n    #             queuePatch(patch)\n    #     # if DEBUG\n    #     #     let innerWatcher = watcher\n    #     #     watcher = (changes) ->\n    #     #         try\n    #     #             innerWatcher(changes)\n    #     #         catch e\n    #     #             # catch and log errors, because object observe callbacks suppress errors\n    #     #             console.error(e)\n\n    #     # call process patch on the object to watch children\n    #     processPatch(object)\n    #     let unobserve = ion.observe(object, watcher, {priority})\n    #     # return an function that lets us unwatch\n    #     return ->\n    #         if callInitial\n    #             watch.count--\n    #         try\n    #             unobserve()\n    #             # unwatch subWatchers\n    #             for key, value of subWatchers\n    #                 value()\n    #         catch e\n    #             console.error('Error in mergePatch unwatch')\n    diff = (oldValue, newValue) ->\n        # returns a patch which can convert from the oldValue to the newValue\n        # returns undefined if there is no difference between them\n        # the patch SHOULD be treated as readonly, since it may reference pre-existing objects\n        if oldValue is newValue\n            return undefined\n        if not(oldValue? and newValue? and typeof newValue is 'object' and typeof oldValue is 'object')\n            return newValue ? null\n        let patch = undefined\n        for name of oldValue if oldValue.hasOwnProperty(name)\n            let propertyDiff = diff(oldValue[name], newValue[name])\n            if propertyDiff isnt undefined\n                patch ?= {}\n                patch[name] = propertyDiff\n        for name of newValue if newValue.hasOwnProperty(name) and not oldValue.hasOwnProperty(name)\n            patch ?= {}\n            patch[name] = newValue[name]\n        return patch\n    isChange = (oldValue, newValue) ->\n        # returns true if a newValue will change the old value\n        # returns false if a newValue will not change the old value\n        if oldValue is newValue\n            return false\n        if not (oldValue? and newValue? and typeof newValue is 'object' and typeof oldValue is 'object')\n            return true\n        for name of newValue\n            if newValue[name] is null and not oldValue.hasOwnProperty(name)\n                continue\n            if isChange(oldValue[name], newValue[name])\n                return true\n        return false\n    test = do ->\n        const equal = (a, b) -> not isChange(a, b) and not isChange(b, a)\n        return\n            merge: ->\n                assert equal({a:{b:2,c:3},d:4}, merge({a:{b:2}}, {a:{c:3},d:4}))\n                assert equal({b:2}, merge(null, {b:2}))\n                assert equal({a:1,b:2}, merge({a:1,b:2,c:3}, {c:undefined}))\n                let double = (x) -> x * 2\n                assert equal({a:double}, merge({},{a:double}))\n            isChange: ->\n                assert isChange({a:1}, null)\n                assert not isChange(null, null)\n                assert isChange(undefined, null)\n                assert isChange(null, undefined)\n                assert not isChange({a:1}, {a:1})\n                assert not isChange({a:{b:2,c:3}}, {a:{b:2}})\n                assert isChange({a:{b:2}}, {a:{b:3}})\n                assert not isChange({a:1}, {b:null})\n            diff: ->\n                assert equal({b:2}, diff({a:1}, {a:1,b:2}))\n                assert equal({a:{b:3,c:null}}, diff({a:{b:2,c:4}}, {a:{b:3}}))\n                assert equal({a:1}, diff(null, {a:1}))\n                assert equal({c:{d:{f:4}}}, diff({a:1,b:2,c:{d:{e:1,f:2}}}, {a:1,b:2,c:{d:{e:1,f:4}}}))\n                assert equal(null, diff({a:1}, undefined))\n                assert equal(null, diff({a:1}, null))\n                assert equal(undefined, diff({a:{b:2}}, {a:{b:2}}))\n            observe: (done) ->\n                if not Object.observe?\n                    return done(null, \"Object.observe missing.\")\n                let source =\n                    name: 'Kris'\n                    age: 41\n                    children: \n                        Sadera:\n                            grandchildren:\n                                One: 1\n                                Two: 2\n                        Orion: {}\n                        Third: {}\n                let target = ion.clone(source, true)\n                let unwatch = watch(\n                    source\n                    (patch) ->\n                        target = merge(target, patch)\n                        # should be immediate assert\n                        if equal(source, target)\n                            done()\n                            unwatch()\n                )\n                source:\n                    name: 'Fred'\n                    children:\n                        Orion:\n                            a: 1\n                            b: 2\n                            c: 12\n                        Sadera:\n                            grandchildren:\n                                three: 3\n                # todo: delete a property in a literal?\n                delete source.children.Third\n                # temp requirement\n                ion.checkForChanges()\n"]}