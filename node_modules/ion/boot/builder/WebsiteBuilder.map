{"version":3,"sources":["WebsiteBuilder.ion"],"names":["global","window","ion","File","Directory","builder","utility","ModuleBuilder","clientJsDir","serverJsDir","serverJavaDir","np","fs"],"mappings":"aAAA;AAAA,IAAGA,MAAA,CAAOC,MAAV,EACA;AAAA,IAAI,OAAJ;AAAA,CADA;AAGA,IACIC,GAAA,G,OAAM,CAAO,KAAP,CADV,EAEIC,IAAA,G,OAAO,CAAO,QAAP,CAFX,EAGIC,SAAA,G,OAAY,CAAO,aAAP,CAHhB,EAIIC,OAAA,G,OAAU,CAAO,IAAP,CAJd,EAKIC,OAAA,G,OAAU,CAAO,WAAP,CALd,EAMIC,aAAA,G,OAAgB,CAAO,iBAAP,CANpB,EAOIC,WAAA,GAAc,IAPlB,EAQIC,WAAA,GAAc,YARlB,EASIC,aAAA,GAAgB,cATpB,EAUIC,EAAA,G,OAAK,CAAO,MAAP,CAVT,EAWIC,EAAA,G,OAAK,CAAO,IAAP,CAXT,CAHA","sourcesContent":["if global.window\n    return\n\nconst\n    ion = import '../'\n    File = import './File'\n    Directory = import './Directory'\n    builder = import './'\n    utility = import './utility'\n    ModuleBuilder = import './ModuleBuilder'\n    clientJsDir = 'js'\n    serverJsDir = 'WEB-INF/js'\n    serverJavaDir = 'WEB-INF/java'\n    np = import 'path'\n    fs = import 'fs'\n\n\nexport template (packagePatch) ->\n    const\n        packageJson = ion.patch(JSON.parse(new File('package.json').read()), packagePatch ? {})\n        input = new Directory(packageJson.directories.src ? 'src')\n        output = new Directory(packageJson.directories.www ? 'debug')\n        clientOutput = output.getDirectory(clientJsDir)\n        serverOutput = output.getDirectory(serverJsDir)\n        nodepaths = ['node_modules'].concat(process.env.NODE_PATH.split(np.delimiter))\n\n    # Copy local development versions of glass-pages to input directory if available\n    # They will be copied from src to the build directory by ant\n    let glassPages = new Directory('../glass-pages/dist')\n    if glassPages.exists\n        let javaDirectory = input.getDirectory(serverJavaDir)\n        for key, source of glassPages.search()\n            let target = javaDirectory.getFile(key)\n            if target.modified < source.modified\n                target.copyFrom(source)\n\n    # Copy client and server node modules to the output\n    for moduleName in packageJson.build.client.modules\n        for nodepath in nodepaths\n            let directory = new Directory(np.join(nodepath, moduleName + \"/lib\"))\n            console.log('checking client directory: ' + directory)\n            for key, source of directory.search([\".js\",\".map\",\".json\"], [].concat(packageJson.build.client.exclude))\n                clientOutput.write(source.path.substring(nodepath.length), source.read())\n    for moduleName in packageJson.build.server.modules\n        for nodepath in nodepaths\n            let directory = new Directory(np.join(nodepath, moduleName + \"/lib\"))\n            console.log('checking server directory: ' + directory)\n            for key, source of directory.search([\".js\",\".map\",\".json\"], [].concat(packageJson.build.server.exclude))\n                serverOutput.write(source.path.substring(nodepath.length), source.read())\n\n    # build client javascript\n    ModuleBuilder(\n        directories:\n            src:input + '/js' # client side javascript\n            lib:output + '/' + clientJsDir\n        build:\n            exclude: packageJson.build.client.exclude\n            test: false\n    )\n\n    # build server javascript\n    ModuleBuilder(\n        directories:\n            src:input + '/js' # server side javascript\n            lib:output + '/' + serverJsDir\n        build:\n            exclude: packageJson.build.server.exclude\n            test: true\n    )\n\n    # Copy all other files from src to output\n    for path, file of input.search(null, [\".ionpage\",\".coffeepage\",\".coffee\",\".java\",\".class\",\".jar\", \".ion\"])\n        if file.isFile\n            output.write(path, file.read(null), null)\n    else\n        output.delete(path)\n\n    # Compile plain ion files, while excluding the js directory\n    for path, file of input.search(\".ion\", \"js\")\n        let targetPath = builder.changeExtension(path, \".js\")\n        output.write(targetPath, builder.compileIon(file))\n    else\n        output.delete(targetPath)\n\n    # Compile ion pages\n    let pageOutput = output.getDirectory('WEB-INF/pages')\n    for path, file of input.search(\".ionpage\")\n        let targetPath = builder.changeExtension(path, \".js\")\n        pageOutput.write(targetPath, \"(function {{path.replace(/[\\.\\/\\\\]/g, '_')}}(){ {{builder.compileIon(file)}} })\")\n    else\n        pageOutput.delete(targetPath)\n\n    # Compile coffee pages\n    # TODO: port all .coffeepages to .ionpages and delete this.\n    for path, file of input.search(\".coffeepage\")\n        let targetPath = builder.changeExtension(path, \".js\")\n        pageOutput.write(targetPath, \"(function {{path.replace(/[\\.\\/\\\\]/g, '_')}}(){ {{builder.compileCoffeeScript(file)}} })\")\n    else\n        pageOutput.delete(targetPath)\n"]}